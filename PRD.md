下面是一份**桌面端离线版（MVP）**的 PRD，你可以直接交给“写代码的 AI / 开发同事”开工。重点覆盖你要求的两件事：

1. **截图公式 → 自动转 LaTeX**
2. **一键复制 → 直接粘贴到 Word，立刻显示为可编辑公式**（不是图片、不是纯文本）
   并支持**历史记忆**与一些高价值辅助功能。

---

# PRD：FormulaSnap（离线桌面端 MVP）

版本：MVP v0.1
平台优先级：**Windows 优先**（Word 粘贴成功率最高）→ macOS（第二阶段）
联网：**不需要服务器**，默认离线运行（可选“用户自配第三方 API”作为后续，不属于 MVP）

---

## 1. 背景与目标

### 1.1 背景问题

用户在 PDF/网页/课件中看到数学公式，想快速写进：

* LaTeX 文档（论文、笔记）
* Word 文档（报告、作业）

传统方式：手敲、MathType、或截图粘贴（不可编辑）效率极低。

### 1.2 产品目标（MVP 必达）

* **全局快捷键**框选截图公式
* 自动识别为 **LaTeX**
* **一键复制**：在 Word 中 **Ctrl+V 直接出现可编辑公式对象**
* 识别结果与历史记录可管理（记忆/搜索/收藏/再复制）

### 1.3 成功指标（可验收）

* 从截图完成到可复制：P95 ≤ 6 秒（在常见笔记本 CPU 上）
* 对印刷体公式的“可用率”（无需改或少量改动）：≥ 85%
* Windows + Word（2016/2019/365 任一）环境下：

  * **复制后直接粘贴显示为可编辑公式**成功率：≥ 90%（用官方测试集）
* 连续 50 次截图识别不崩溃；内存不持续增长（< 300MB 增量）

---

## 2. 用户画像与场景

### 2.1 用户

* 学生/研究人员：论文公式、作业推导
* 工程师/算法/数据：技术报告、方案文档
* 教师：出题、讲义

### 2.2 核心场景

1. 从 PDF 截图一个公式 → 粘贴到 Word 里直接成为公式
2. 截图多个公式 → 依次粘贴到 Word/LaTeX
3. 历史公式复用：搜索某个符号/结构，重复复制
4. 识别不准：快速手改 LaTeX 并保存

---

## 3. 产品范围

### 3.1 MVP 范围（必须做）

* 全局截图（框选）
* 离线 Math OCR：图片 → LaTeX
* 结果预览：截图缩略图 + LaTeX 编辑框 + 公式渲染预览
* 一键复制：

  * **复制 LaTeX**
  * **复制 Word 公式（可编辑）**
* 历史记忆：

  * 自动保存：图片缩略图（可选）、LaTeX、时间、置信度
  * 搜索/收藏/再次复制
* 导出（MVP 可做简版）：

  * 导出 `.tex`（选中多条历史）
  * 导出 `.docx`（选中多条历史，公式为可编辑公式）

### 3.2 明确不做（MVP 排除）

* 手写公式识别
* 整页 PDF 自动抽取所有公式
* 复杂多行推导 100% 版式还原（先保证可用 LaTeX）

---

## 4. 功能需求（详细）

### 4.1 截图与输入

**FR-1 全局快捷键截图**

* 默认快捷键：`Ctrl + Shift + 2`（可配置）
* 进入截图模式：十字光标框选区域
* 框选完成后自动识别（显示 loading）

**FR-2 其他输入**

* 支持从剪贴板粘贴图片（Ctrl+V）
* 支持拖拽图片文件到窗口

**验收**

* 任意窗口上层可唤起截图
* 截图后 300ms 内出现识别中状态

---

### 4.2 离线公式识别（Math OCR）

**FR-3 离线识别引擎**

* 输入：截图图片（RGB/灰度）
* 输出：LaTeX 字符串 + 置信度（0~1）
* 预处理（至少包含）：

  * 自动裁边（去空白）
  * 对比度增强（可选开关）
  * 缩放到模型推荐尺寸

**FR-4 失败处理**

* 识别为空/失败：提示“可能未检测到公式”，支持：

  * 一键重试（可切换预处理选项）
  * 手动编辑 LaTeX 仍可复制/保存

**验收**

* 常见印刷体公式识别可用率≥85%
* 失败不阻塞 UI，≤10 秒超时返回

---

### 4.3 结果编辑与渲染

**FR-5 LaTeX 编辑**

* 文本框可编辑，支持撤销/重做
* 编辑时右侧实时渲染预览（KaTeX/MathJax）

**FR-6 快捷包裹**

* 一键切换输出包裹格式：

  * 行内：`\(...\)`
  * 行间：`\[...\]` 或 `$$...$$`
* 复制 LaTeX 时按当前包裹规则输出

---

### 4.4 关键功能：复制到 Word 直接成“可编辑公式”

这是 MVP 的核心差异点。

#### 4.4.1 Word 粘贴目标

**FR-7 复制 Word 公式**

* 点击“复制到 Word”后，用户在 Word 里 **Ctrl+V**：

  * 粘贴内容立刻显示为 **Word 原生公式对象**（可点击编辑）
  * 不是图片、不是普通文本

#### 4.4.2 实现策略（工程规范写进 PRD）

MVP 采取“**多格式写剪贴板**”策略，最大化 Word 命中率：

* 必写：

  1. **OMML**（Office Math Markup Language）对应的可插入片段（主路径）
  2. **MathML**（作为兼容备选）
  3. `text/plain`（LaTeX，兜底）

* Windows 优先增强（强烈建议）：

  * 同时写入 `RTF` 或 `HTML`（如果包含 Word 识别公式所需结构），让 Word 优先选择富文本格式

> 说明：不同 Word 版本/渠道对剪贴板格式选择略有差异；因此“多格式冗余”是 MVP 必须项。

#### 4.4.3 LaTeX → OMML 转换（离线）

**FR-8 转换链**

* 将识别/编辑后的 LaTeX 转为 OMML
* 转换失败时：

  * “复制到 Word”按钮仍可用，但会触发兜底：把 LaTeX 放入剪贴板，并提示用户“在 Word 公式中粘贴并转换”（MVP 可接受少量兜底，但目标是默认直接成功）

#### 4.4.4 验收标准（必须写清楚）

* 在 Windows 10/11 + Word（至少覆盖一个版本：Microsoft 365 或 2019）：

  * 复制到 Word → Ctrl+V 直接出现可编辑公式，成功率≥90%（对官方测试集）
* 若未成功触发公式：

  * 应提示“一键修复方式”（例如：Alt+= 进入公式再粘贴/转换），并提供“复制 LaTeX”按钮

---

### 4.5 历史记忆（本地）

**FR-9 历史记录**

* 自动保存每次识别结果：

  * 时间、LaTeX（原始+编辑版）、置信度、引擎版本
  * 截图缩略图：默认保存（可在设置中关闭“仅存文本”）
* 支持操作：

  * 搜索（按 LaTeX 关键词）
  * 收藏
  * 标签（MVP 可选做简版：仅收藏+搜索）

**FR-10 历史复用**

* 每条历史都有按钮：

  * 复制 LaTeX
  * 复制到 Word（公式）
  * 打开编辑

---

### 4.6 导出（MVP 简版即可）

**FR-11 导出 .tex**

* 勾选多条历史 → 导出一个 `.tex`（按时间排序）
* 可选择是否自动加分隔（如空行/注释时间）

**FR-12 导出 .docx**

* 勾选多条历史 → 生成 `.docx`
* docx 中每条为一个段落公式（OMML）
* 若某条转换失败：插入 LaTeX 文本并标注“转换失败”

---

## 5. 非功能需求

* 离线运行：不依赖网络，不上传图片
* 性能：识别线程与 UI 分离；支持取消识别
* 稳定：错误可恢复；崩溃时自动保存未导出的历史
* 隐私：提供“仅保存 LaTeX 不保存图片”的开关

---

## 6. 设计与交互（MVP 界面）

### 6.1 流程

1. 快捷键截图
2. 弹出小窗（置顶）显示：截图预览 + loading
3. 识别完成：

   * 左：截图预览（可重新裁剪）
   * 中：LaTeX 编辑框
   * 右：渲染预览
   * 底部按钮：**复制到 Word / 复制 LaTeX / 保存 / 重试**
4. 自动写入历史

### 6.2 历史面板

* 右侧列表：缩略图 + 渲染小预览 + 时间
* 顶部搜索框
* 条目操作：复制到 Word / 复制 LaTeX / 编辑 / 收藏

---

## 7. 技术方案（给 AI 开发的落地指引）

### 7.1 推荐架构（Windows 优先）

* UI：Tauri（轻量）或 Electron（生态强）
* OCR：离线模型（例如 pix2tex 或其他开源 math ocr）
* 存储：SQLite
* 渲染：KaTeX
* 剪贴板：原生 API（Windows Clipboard）写多格式

### 7.2 模块拆分

1. CaptureService：全局热键、截图框选、生成 bitmap/png
2. PreprocessService：裁边、增强、缩放
3. OcrService：图片→LaTeX+置信度
4. ConvertService：LaTeX→MathML→OMML（或直接 LaTeX→OMML）
5. ClipboardService：写入多格式（OMML/MathML/plain/RTF/HTML）
6. HistoryService：SQLite CRUD + 搜索索引
7. ExportService：tex/docx 导出

---

## 8. 开源调研结果（可复用/参考清单）

> 这部分可以直接放 PRD “依赖与调研”章节，方便 AI 选型与拼装。

### 8.1 Math OCR（离线公式识别）

* **LaTeX-OCR / pix2tex**：成熟、社区大，适合“公式截图→LaTeX”
* **Texify**：更偏“文字+公式”混排
* **Pix2Text**：更工具化，多任务（公式/文本/版面）

### 8.2 LaTeX ↔ OMML 转换

* **texmath**：支持 TeX/MathML/OMML 等互转（注意许可证风险，需评估是否适合你的分发方式）
* **LatexConverter**（LaTeX→OMML 的 Python/XSLT 路线）
* **Plurimath**：多格式数学互转生态

### 8.3 “复制粘贴进 Word”策略参考

* **CopyEquation / PasteEquation**：虽然是网页公式→Word，但对“剪贴板多格式 + Word 侧适配”的思路非常接近你的需求，可借鉴粘贴链路与格式选择策略。

---

## 9. 测试用例与验收（必须准备一套“公式测试集”）

### 9.1 测试集分层（建议至少 50 条）

* 基础：上下标、希腊字母、简单分式（15）
* 中等：根号、积分/求和、组合符号（20）
* 高级：矩阵、分段函数、对齐环境（15）

每条包含：

* 原图（截图）
* 预期 LaTeX（允许等价写法）
* Word 粘贴预期：是否应直接变公式

### 9.2 验收脚本

* 自动化（可选）：批量跑 OCR + 统计置信度分布
* 人工验收：

  * 点击“复制到 Word”→打开 Word→Ctrl+V→确认是否为公式对象（可编辑）

---

## 10. 里程碑（MVP 交付拆解）

* M0（最小跑通）：截图→OCR→显示 LaTeX→复制 LaTeX→历史入库
* M1（关键）：LaTeX→OMML 转换→剪贴板多格式→Word 直接粘贴成公式
* M2（完善）：导出 docx/tex、搜索、收藏、重试与预处理选项

---

## 11. 关键风险与对策（务必写进 PRD）

1. **Word 粘贴依赖版本差异**

   * 对策：剪贴板写多格式（OMML/MathML/plain/RTF/HTML）；优先 Windows MVP
2. **LaTeX→OMML 转换覆盖不全**

   * 对策：先保证常见公式；失败回退 LaTeX 并提示修复路径
3. **离线模型体积大、首次启动慢**

   * 对策：首次启动引导下载/解压模型；后台预热；提供轻量模型选项（后续）

---

如果你希望我把它变成“更适合直接让 AI 写代码的工程规格”，我可以下一条直接补上：

* 每个模块的接口定义（函数签名/输入输出）
* Windows 剪贴板需要写入的格式清单（工程任务列表）
* 目录结构（Tauri/Electron 二选一）
* 50 条测试公式样例的模板（你只要填图）

你希望用 **Tauri** 还是 **Electron**？（不回答我就默认 Tauri，给你一份更偏“可执行任务清单”的版本。）
