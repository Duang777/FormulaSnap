name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller texify

      - name: Build OCR engine with PyInstaller
        run: |
          cd scripts
          pyinstaller ocr_server.py --onedir --name=ocr_engine --distpath=../src-tauri --workpath=../build/pyinstaller --specpath=../build --clean --noconfirm --noconsole --collect-all=texify --collect-all=transformers --collect-all=tokenizers --hidden-import=texify --hidden-import=texify.inference --hidden-import=texify.model.model --hidden-import=texify.model.processor
        shell: pwsh

      - name: Verify OCR engine build
        run: |
          echo "OCR engine directory structure:"
          Get-ChildItem -Path src-tauri/ocr_engine -Recurse -Name | Select-Object -First 50
          echo "Checking for ocr_engine.exe:"
          Test-Path src-tauri/ocr_engine/ocr_engine.exe
        shell: pwsh

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri build

      - name: Find build output
        run: |
          echo "Looking for msi files..."
          Get-ChildItem -Path . -Recurse -Filter "*.msi" | Select-Object FullName
          echo "Looking for exe files..."
          Get-ChildItem -Path . -Recurse -Filter "*setup*.exe" | Select-Object FullName
        shell: pwsh

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          files: |
            src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
